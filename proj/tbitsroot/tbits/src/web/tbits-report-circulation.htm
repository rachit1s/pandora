<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Schedule report</title>

<link rel="stylesheet" type="text/css" href="<%=nearestPath%>web/yui/build/logger/assets/skins/sam/logger.css" />
<link rel="stylesheet" type="text/css" href="<%=nearestPath%>web/yui/build/treeview/assets/skins/sam/treeview.css" />
<link rel="stylesheet" type="text/css" href="<%=nearestPath%>web/yui/build/button/assets/skins/sam/button.css" />
<link rel="stylesheet" type="text/css" href="<%=nearestPath%>web/yui/build/autocomplete/assets/skins/sam/autocomplete.css">

<script type="text/javascript" src="<%=nearestPath%>web/yui/build/yahoo/yahoo.js"></script>
<script type="text/javascript" src="<%=nearestPath%>web/yui/build/yuiloader/yuiloader-beta-min.js"></script>
<script type="text/javascript" src="<%=nearestPath%>web/yui/build/event/event-min.js"></script>
<script type="text/javascript" src="<%=nearestPath%>web/yui/build/dom/dom-min.js"></script>
<script type="text/javascript" src="<%=nearestPath%>web/yui/build/logger/logger-min.js"></script>
<script type="text/javascript" src="<%=nearestPath%>web/yui/build/treeview/treeview-debug.js"></script>
<script type="text/javascript" src="<%=nearestPath%>web/yui/build/element/element-beta-min.js"></script>
<script type="text/javascript" src="<%=nearestPath%>web/yui/build/button/button-min.js"></script>
<script type="text/javascript" src="<%=nearestPath%>web/yui/build/yahoo-dom-event/yahoo-dom-event.js"></script>
<script type="text/javascript" src="<%=nearestPath%>web/yui/build/animation/animation-min.js"></script>
<script type="text/javascript" src="<%=nearestPath%>web/yui/build/autocomplete/autocomplete-min.js"></script>
<script type="text/javascript" src="<%=nearestPath%>web/scripts/add-report.js"></script>
<script type="text/javascript" src="<%=nearestPath%>web/scripts/json2.js"></script>
<script type="text/javascript" src="<%=nearestPath%>web/yui/assets/js/TaskNode.js"></script>

<style type="text/css">
	.ygtvcheck0 { background: url(<%=nearestPath%>web/yui/assets/img/check/check0.gif) 0 0 no-repeat; width:16px; cursor:pointer }
	.ygtvcheck1 { background: url(<%=nearestPath%>web/yui/assets/img/check/check1.gif) 0 0 no-repeat; width:16px; cursor:pointer }
	.ygtvcheck2 { background: url(<%=nearestPath%>web/yui/assets/img/check/check2.gif) 0 0 no-repeat; width:16px; cursor:pointer }
</style>

<style type="text/css">
	#expandcontractdiv {border:1px solid #336600; background-color:#FFFFCC; margin:0 0 .5em 0; padding:0.2em;}
	#treeDiv1 { background: #fff }
	#treeDiv2 { background: #fff }
</style>

<script>
	YAHOO.namespace("transbit.tbits");
	var ba = <%=baRoleMap%>;
	var userList = <%=usersList%>;
	var paramList = eval(<%=reportParamList%>);
	
	function addParamFields(tableId){
		if ((paramList !== null) || (paramList!='')){
			//var param = paramList.split(",");
			for (var i=0; i<paramList.length; i++){
				if ((paramList[i].parameterNames!=="tbits_base_url") && (paramList[i].parameterNames!=="user_id")){
				  var tbl = document.getElementById(tableId);
				  var lastRow = tbl.rows.length;
				  // if there's no header row in the table, then iteration = lastRow + 1
				  var iteration = lastRow;
				  var row = tbl.insertRow(lastRow - 1);
				  
				  // left cell
				  var cellLeft = row.insertCell(0);
				  var textNode = document.createTextNode(paramList[i].parameterNames);
				  var el1 = document.createElement('input');
				  el1.type = 'hidden';
				  el1.name = "parameterNames";
				  el1.id = 'txtRow' + iteration;
				  el1.value = paramList[i].parameterNames;				  
				  cellLeft.appendChild(el1);
				  cellLeft.appendChild(textNode);
				  
				  // right cell
				  var cellRight = row.insertCell(1);
				  var el = document.createElement('input');
				  el.type = 'text';
				  el.name = "parameterValues";
				  el.id = 'txtRow' + iteration;
				  el.value = paramList[i].parameterValues;
				  el.size = 40;
				  cellRight.appendChild(el);
			  	}
			}
		}
	}
</script>

<script>			
	function treeInit() {					
		//buildRandomTaskNodeTree("treeDiv1");
		buildRandomTaskNodeTree("treeDiv2");
	}							
									
	YAHOO.util.Event.on("getchecked", "click", function(e) {						
		YAHOO.util.Event.preventDefault(e);
	});
									
	//Function  creates the tree and 
	//builds between 3 and 7 children of the root node:
	function buildRandomTaskNodeTree(treeId) {								
		//instantiate the tree:
		var baRoleMap;
		tree = new YAHOO.widget.TreeView(treeId);
		if (treeId == "treeDiv1")
			baRoleMap = eval(document.getElementById("runAsUsersBARoleMap").value);
		else if (treeId == "treeDiv2")
			baRoleMap = eval(document.getElementById("recipientBARoleMap").value);
		for (var i = 0; i < ba.length ; i++){
			var selectedRoles = getMatchingBA(baRoleMap, ba[i].baName);
			var tmpNode = new YAHOO.widget.TaskNode (ba[i].baName, tree.getRoot(), false);							
			if (ba[i].roles != null){
				buildRandomTaskBranch(tmpNode, ba[i].roles.split(","), selectedRoles);
			}
		}							
	//The tree is not created in the DOM until this method is called:
	tree.draw();
	}
	
	function getMatchingBA(baRoleMap, baName){
		for (var i=0; i<baRoleMap.length;i++)
			if (baRoleMap[i].ba == baName)
				return baRoleMap[i].roles;
			else
				continue;			
	}
									
	var callback = null;
									
	/*function buildRandomTaskBranch (node, rolesList) {
		for (var i = 0; i < rolesList.length; i++) {
			var tmpNode = new YAHOO.widget.TaskNode(rolesList[i], node, false);
		}
	}*/
	function buildRandomTaskBranch (node, rolesList, selectedRoles) {
		var selected = false;
		for (var i = 0; i < rolesList.length; i++) {
			if ((selectedRoles !== "undefined") && (selectedRoles != null)){				
				for (var k=0; k<selectedRoles.length; k++){
					if (selectedRoles[k] == rolesList[i]){
						selected = true; 
						break;
					}
					else
						continue;	
				}
			}
			var tmpNode = new YAHOO.widget.TaskNode(rolesList[i], node, false, selected);
			selected = false;
		}
	}
							
	/*function checkAll() {
		var topNodes = tree.getRoot().children;
		for(var i=0; i<topNodes.length; ++i) {
			topNodes[i].check();
		}
	}
									
	function uncheckAll() {
		var topNodes = tree.getRoot().children;
		for(var i=0; i<topNodes.length; ++i) {
			topNodes[i].uncheck();
		}
	}*/
									
	function onLabelClick(node) {
	   new YAHOO.widget.TaskNode("new", node, false);
	   node.refresh();
	   return false;
	}
																
	// Gets the labels of all of the fully checked nodes
	// Could be updated to only return checked leaf nodes by evaluating
	// the children collection first.
	function getCheckedNodes(nodes, treeId) {
		if (treeId !== ''){
			var tree = YAHOO.widget.TreeView.getTree(treeId);
			nodes = nodes||tree.getRoot().children;
		}
		
		checkedNodes = [];
		for(var i=0, l=nodes.length; i<l; i=i+1) {
			var n = nodes[i];
			if (n.checkState > 0) { // if we were interested in the nodes that all children
			//if (n.checkState === 2) {
				checkedNodes.push(n.label); // just using label for simplicity
			}
										
			if (n.hasChildren()) {
				checkedNodes = checkedNodes.concat(getCheckedNodes(n.children, ''));
			}
		}		
		return checkedNodes;
	}	
	
	function getBAAndUsers(treeType){
		if (treeType == 'runAsUsers'){
			var baUsers = getCheckedNodes('', 'treeDiv1');
			return baUsers;
		}
		if (treeType == 'recipients'){
			var baUsers = getCheckedNodes('', 'treeDiv2');
			return baUsers;
		}
	}
			
	YAHOO.util.Event.onDOMReady(treeInit);
	
	function getBARoleMap(treeType){
		var baRoles = getBAAndUsers (treeType); 
		var baRolesMap = [];
		for (var i=0; i<baRoles.length; i++){						
			if (isBA(baRoles[i])){
				var newObj = new Object();
				newObj.ba = baRoles[i];
				newObj.roles = getRoles (baRoles[i], baRoles, i);				
				baRolesMap.push(newObj);
			}
		}
		return baRolesMap;
	}
	
	function getRoles (sysPrefix, baRoles, index){
		var rList = [];	
		index = index + 1;	//should start after the current index
		for (var j=index; j < baRoles.length; j++){	
			if (isBA (baRoles[j])){
				return rList;							
			}
			else{
				//rList = (rList == "")? baRoles[j] : rList + "," + baRoles[j];
				rList.push (baRoles[j]);	
			}
		}			
		return rList;
	}	
	
	function isBA (name){
		for (var i=0 ; i<ba.length; i++){
			if (ba[i].baName == name)
				return true;
		}
		return false;
	}	
	
	function optionsList (elemId){
		var list = [];
		var selectEl = document.getElementById (elemId);
		if (selectEl.options.length > 0)	
			for (var i=0; i<selectEl.options.length; i++){
				var temp = selectEl.options[i].value; 
				if ((temp != null) || (temp != "") || (temp != " "))
					list.push (temp);
			}
		return list; 
	}
	
	function toggleElement (ctrlId){
		var ctrl = document.getElementById(ctrlId);
		if (ctrl.style.display == 'none')
			ctrl.style.display = 'block'; 
		else 
			ctrl.style.display = 'none';
	}
	
	function onPerUser(ctrlId1, ctrlId2){
		toggleElement(ctrlId1);
		toggleElement(ctrlId2);
		var isChecked = document.getElementById("isPerUserReportId");
		isChecked.value = (isChecked.value == "") ? "on" : "";		
	}
	
	function saveSchedule(){
		/*var x = document.getElementById("runAsUsersBARoleMap");
		var tempBARoleMap = getBARoleMap("runAsUsers");
		var tempIncludeUsers = optionsList("includeUsers1");
		var tempExcludeUsers = optionsList("excludeUsers1");
		x.value = JSON.stringify(tempBARoleMap);*/
		
		var recpElem = document.getElementById("recipientBARoleMap");
		var recpBARole = getBARoleMap("recipients");
		var includeRecps = optionsList("includeUsers2");
		var excludeRecps = optionsList("excludeUsers2"); 		
		recpElem.value = JSON.stringify(recpBARole);
		
		//document.getElementById("includeUsersList").value = JSON.stringify(tempIncludeUsers);
		//document.getElementById("excludeUsersList").value = JSON.stringify(tempExcludeUsers);
		document.getElementById("includeRecipientsList").value = JSON.stringify(includeRecps);
		document.getElementById("excludeRecipientsList").value = JSON.stringify(excludeRecps);
		document.reportScheduleForm.action = "<%=nearestPath%>reportcirculation";
		document.reportScheduleForm.submit();
		self.close();
	}	
		
</script>
</head>

<body style="background-color:#FFFFFF; width:100%" onLoad='javascript:addParamFields("paramTable")'>
	<DIV  class ="bbn"  style="width:100%">
    	<TABLE id="Table1" cellSpacing="0" cellPadding="0"style="width:100%; background-image:url(<%=nearestPath%>web/images/header-sec.gif); background-repeat:repeat-x;">
        	<TR class="sxs"><td align="top"><img src="<%=nearestPath%>web/images/header-first.gif" /></td>
            	<td align="left">
                	<DIV class="m">
                    	<div>Administration - Report Schedule
                        	<!--SELECT id="sys_ids" size="1" name="Select1" onChange="javascript:onPropertyChangeSysIdProperties()">
                            	<%=sys_ids%>
                            </SELECT-->
                        </div>
                    </DIV>
                </TD>
                <td><div align="right">
					<span class="lc sx b cw"><%=userLogin%></span><span class="l sx b cw" style="display:<%=display_logout%>">|<a href="<%=nearestPath%>logout"/>Logout</a></span><br>
					<SPAN class="l cw" id="" onClick="window.open('<%=nearestPath%>web/tbits-help.htm#WhatIsConfigurable');"><img src="<%=nearestPath%>web/images/help.gif">&nbsp;Help</SPAN> </div></TD>
             </TR>
    	</TABLE>
	</DIV> <!-- panel header -->
	<div style="background-color:#E6F4FD; margin: 0ex 1ex 0.5ex;border:0.2ex solid #CBCBCB;">
	<input type="hidden" name="baRoleMap" value="<%=baRoleMap%>" ID="baRoleMap"/>
	<input type="hidden" name="usersList" value="<%=usersList%>" ID="usersList"/>	
	<form name="reportScheduleForm" id="scheduleFormId" action="post">
	<input type="hidden" id= "actionTypeId" name="actionType" value="save">
	<input type="hidden" id= "saveTypeId" name="saveType" value="<%=saveType%>">
	<input type="hidden" name="reportName" value="<%=reportName%>" ID="reportNameId"/>	
	<div>
		<div class="style2" style="font-weight:bold">Report Schedule:</div>
		<table id="paramTable" width="559" style="width:80%">
			<tr>
				<td width="105" style="width:40%"> Job Name:</td>
			  	<td width="438" style="width:60%">
					<input type="text" name="jobName" size="40" value="<%=jobName%>">
					<input type="hidden" name="jobGroup" value="Reports" ID="jobGroupId"/>
				</td>				
			</tr>
			<tr>
				<td style="width:40%">Job Class</td>
				<td style="width:60%"><input type="text" name="className" size="40" value="<%=className%>"></td>
			</tr>
			<tr>
				<td style="width:40%">Job Description:</td>
				<td style="width:60%"><input type="text" name="description" size="40" value="<%=description%>"></td>
			</tr>			
			<tr>
				<td style="width:40%">Schedule:(Cron Expression)</td>
				<td style="width:60%">
					<input type="text" name="cronExpression" size="40" value="<%=cronExpression%>"> 
					<input type="button" name="test-cron" value="Test">
				</td>
			</tr>
			<tr>
				<td style="width:40%">Email Subject:</td>
				<td style="width:60%"><input type="text" name="emailSubject" size="40" value="<%=emailSubject%>"></td>
			</tr>
			<tr>
				<td style="width:40%">Report Name
					<input type="hidden" name="parameterNames" value="reportfile"> 
				</td>
				<td style="width:60%"><input type="text" id="reportFileName" name="parameterValues" size="40" value="<%=reportfile%>"></td>
			</tr>
			<tr>
				<td style="width:20%" colspan="2"><strong>Run As:</strong></td>
			</tr>
	  </table>
		<div style="width:100%; border:0.2ex solid #CBCBCB;">
			<div>
				<label><input type="checkbox" id="isPerUserReportId" name="isPerUserReport" <%=isPerUserReport%>  onClick="javascript:onPerUser('recipientsId', 'runAsUserAutoComplete')">Per User Report</label>			  
			</div>			   
			<div style="display:<%=display_recipients%>" id="runAsUserAutoComplete">
				<div class=" yui-skin-sam">Run As User:
					<div id="userautocomplete1">
						<input id="runsAsUserId" name="runAsUser" type="text" style="width:200px" value="<%=runAsUser%>">
						<div id="usercontainer1"></div>
					</div>
				</div><br />
			</div>
			<div><br/></div>	
		</div>
		<div id="recipientsId" style="display:<%=display_recipients%>">
		<p><strong>Recipients of each report run:</strong></p>
		<table style="width:100%; border:0.2ex solid #CBCBCB;">
          <tr>
            <th style="width:40%">Business Area-Roles</th>
            <th style="width:30%">Include Users</th>
            <th style="width:30%">Exclude Users</th>
          </tr>
          <tr >
            <td vertical-align:text-top;>
				<div class="promo" style="width:100%; border:thin inset">
                	<div class="example-container module">
                 	 <div id="example-canvas2" class="bd">
                    	<div id="treeDiv2" style="height:200px;overflow:auto"></div>
                  	 </div>
                	</div>
            	</div>
			</td>
            <td style="vertical-align:text-top;">
				<select name="select" multiple="multiple" id="includeUsers2" style="width:100%;height:200px;">
				<%=includeRecipients%></select>
            </td>
            <td style="vertical-align:top">
				<select name="select" multiple="multiple" id="excludeUsers2" style="width:100%;height:200px">
				<%=excludeRecipients%></select>
            </td>
          </tr>
          <tr>
            <td></td>
            <td>
				<div class=" yui-skin-sam">
                	<div id="userautocomplete3">
					  <input id="userinput3" name="user-input3" type="text" style="width:200px">
                 	  <div id="usercontainer3"></div>
                	</div>
            	</div>
			</td>
            <td>
				<div class=" yui-skin-sam">
					<div id="userautocomplete4">
					  <input id="userinput4" name="user-input4" type="text" style="width:200px">
					  <div id="usercontainer4"></div>
					</div>
            	</div>                
            </td>
          </tr>
		  <tr>
		  	<td></td>
			<td>
				<br />
                <input id="add3" type="button" name="adduser3" value="Add" onClick="javascript:addUser('userinput3', 'includeUsers2',2);">
                <input id="remove3" type="button" name="removeUser3" value="Remove" onClick="javascript:removeUser( 'includeUsers2',2);">
			</td>
			<td>
				<br />
                <input id="add4" type="button" name="adduser4" value="Add" onClick="javascript:addUser('userinput4', 'excludeUsers2',2)">
                <input id="remove4" type="button"  name="removeUser4" value="Remove" onClick="javascript:removeUser( 'excludeUsers2',2);">
			</td>
		  </tr>
        </table>
		<table style="width:80%">		
			<tr> 
				<td style="width:30%">Body: </td>
				<td style="width:70%"><textarea title="Body" name="emailBody" cols="80" rows="3" ><%=emailBody%></textarea></td>
			</tr>
		</table>
		</div>
		<div style="width=80%">
			<span style="width:50%"> 				
				<span style="width:30%">Format:</span> 
				<span style="width:70%">
					<select name="format" id="report-format">
					  <option>.pdf</option>
					  <option>.html</option>
					</select>	  
				</span>
			</span>
			<span style="width:50%"> 
				<span style="width:30%">Attachment:</span>
				<span style="width:70%">
					<select name="attachmentType" id="attachmentId">
			  			<option>inline</option>
			  			<option>attachment</option>
					</select>
				</span>
			</span>
	  </div>
	  </div>
		<div>
			<br />
			<!--input type="hidden" name="runAsUsersBARoles" id="runAsUsersBARoleMap"  value='<%=runAsUsersBARoles%>'/>
			<input type="hidden" name="runAsIncludeUsers" id="includeUsersList" value=''/>
			<input type="hidden" name="runAsExcludeUsers" id="excludeUsersList" value=''/-->
			<input type="hidden" name="recipientsBARoles" id="recipientBARoleMap"  value='<%=recipientsBARoles%>'>
			<input type="hidden" name="includeRecipients" id="includeRecipientsList" value=''/>
			<input type="hidden" name="excludeRecipients" id="excludeRecipientsList" value=''/>
			<input type="button" value="Save" onClick="javascript:saveSchedule()">
		</div>				 
	</div>
	</form>
	</div>
	<script type="text/javascript">		
		var usersList = <%=usersList%>;		
		YAHOO.transbit.tbits.ACJSArray1 = autoCompleteFunction ('runsAsUserId', 'usercontainer1', usersList);
		//YAHOO.transbit.tbits.ACJSArray2 = autoCompleteFunction ('userinput2', 'usercontainer2', usersList);	
		YAHOO.transbit.tbits.ACJSArray3 = autoCompleteFunction ('userinput3', 'usercontainer3', usersList);
		YAHOO.transbit.tbits.ACJSArray4 = autoCompleteFunction ('userinput4', 'usercontainer4', usersList);	
		
		function autoCompleteFunction (userinput, usercontainer, itemsList){
			// Instantiate second JS Array DataSource
			this.oACDS = new YAHOO.widget.DS_JSArray(itemsList);
										
			// Instantiate first AutoComplete
			this.oAutoComp = new YAHOO.widget.AutoComplete(userinput,usercontainer, this.oACDS);
			this.oAutoComp.prehighlightClassName = "yui-ac-prehighlight";
			this.oAutoComp.typeAhead = true;
			this.oAutoComp.useShadow = true;
			this.oAutoComp.minQueryLength = 0;
			this.oAutoComp.textboxFocusEvent.subscribe(function(){
				var sInputValue = YAHOO.util.Dom.get(userinput).value;
				if(sInputValue.length === 0) {
					var oSelf = this;
					setTimeout(function(){oSelf.sendQuery(sInputValue);},0);
				}
			});								
		}
	</script>	
</body>
</html>
